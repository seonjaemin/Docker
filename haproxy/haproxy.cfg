global
    daemon
    maxconn 4096
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull

    # --- Keep-Alive 핵심 ---
    option  http-keep-alive          # HTTP 연결을 끊지 않고 재사용(클라이언트/백엔드 공통)
    timeout http-keep-alive 10s      # 유휴 Keep-Alive 연결 유지 시간(너무 길면 리소스 묶임)

    # (권장) 요청 타임아웃도 명시
    timeout http-request 10s

    # 기존 타임아웃
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    # 라운드 로빈
    balance roundrobin

frontend fe_in
    bind *:9000
    default_backend be_pool
    # 프런트엔드는 defaults의 http-keep-alive 설정을 그대로 상속받음

backend be_pool
    # --- 백엔드 Keep-Alive/연결 재사용 ---
    # 서버 간 요청을 보낼 때 기존 연결을 '안전하게(safe)' 재사용
    # (세션/헤더 충돌 위험을 최소화하면서 성능 향상)
    http-reuse safe

    # 서버 3대를 라운드로빈 대상에 등록 + 헬스체크
    server bk1 backend-1:8000 check inter 5s fall 3 rise 2
    server bk2 backend-2:8000 check inter 5s fall 3 rise 2
    server bk3 backend-3:8000 check inter 5s fall 3 rise 2

# (옵션) 통계 페이지: http://<호스트IP>:8404/haproxy?stats
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /haproxy?stats
    stats refresh 5s

